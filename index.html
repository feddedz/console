<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Colab Terminal Bridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the terminal look */
        body {
            background-color: #111827;
            font-family: 'Fira Code', monospace;
        }
        #terminal-output, #terminal-input {
            font-size: 14px;
            color: #E5E7EB;
        }
        .terminal-container {
            max-width: 900px;
            min-height: 600px;
            background-color: #1f2937;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #374151;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .connected { background-color: #10b981; } /* Green */
        .disconnected { background-color: #ef4444; } /* Red */
        .connecting { background-color: #f59e0b; } /* Yellow */

        .prompt-text { color: #4ade80; }
        .path-text { color: #93c5fd; }
        #terminal-output::-webkit-scrollbar { width: 8px; }
        #terminal-output::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="terminal-container w-full flex flex-col">
        <!-- Control Panel -->
        <div class="bg-gray-700 p-2 flex items-center justify-between text-xs text-gray-200">
            <div class="flex items-center">
                <span id="connection-status" class="status-dot disconnected"></span>
                Status: <span id="status-text">Disconnected</span>
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="ngrok-url-input" placeholder="Paste Ngrok/WebSocket URL (e.g., wss://xyz.ngrok-free.app/)" class="bg-gray-800 text-gray-200 p-1 rounded w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="connect-button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Connect</button>
            </div>
        </div>

        <!-- Terminal Output Area -->
        <div id="terminal-output" class="p-4 flex-grow overflow-y-auto whitespace-pre-wrap">
            <div class="text-xs text-gray-400 mb-2">
                Enter the WebSocket URL from your running Colab/Ngrok session above and click Connect.
                <hr class="border-gray-600 my-2">
            </div>
        </div>

        <!-- Terminal Input Area -->
        <div class="flex p-4 border-t border-gray-700 flex-shrink-0">
            <label for="terminal-input" class="flex-shrink-0">
                <span class="prompt-text">colab-remote</span>:<span class="path-text">~</span><span class="prompt-text">$</span>&nbsp;
            </label>
            <input type="text" id="terminal-input" class="flex-grow bg-transparent border-none focus:outline-none" autofocus autocomplete="off" disabled>
        </div>
    </div>

    <script>
        const outputElement = document.getElementById('terminal-output');
        const inputElement = document.getElementById('terminal-input');
        const connectButton = document.getElementById('connect-button');
        const urlInput = document.getElementById('ngrok-url-input');
        const statusDot = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        let ws = null;

        // Function to append text to the terminal output
        function appendOutput(text, isInput = false) {
            if (isInput) {
                // Prepend prompt for user input
                text = `<span class="prompt-text">colab-remote</span>:<span class="path-text">~</span><span class="prompt-text">$</span> ${text}`;
            }
            // Use innerHTML += to maintain formatting/colors
            outputElement.innerHTML += text + '\n';
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        
        // Update connection status display
        function updateStatus(state, message) {
            statusDot.className = 'status-dot ' + state;
            statusText.textContent = message;
            if (state === 'connected') {
                inputElement.disabled = false;
                inputElement.focus();
            } else {
                inputElement.disabled = true;
            }
        }

        // --- WebSocket Handlers ---
        
        function handleConnect() {
            if (ws) {
                ws.close();
                ws = null;
            }

            let url = urlInput.value.trim();
            if (!url.startsWith('ws')) {
                // Ensure the user inputs the correct protocol (ws or wss)
                appendOutput("Error: URL must start with 'ws://' or 'wss://'", false);
                return;
            }

            updateStatus('connecting', 'Connecting...');
            
            try {
                // Create WebSocket connection
                ws = new WebSocket(url);

                ws.onopen = () => {
                    updateStatus('connected', 'Connected to Colab VM via Ngrok!');
                    appendOutput("Successfully connected. Type commands below.", false);
                };

                ws.onmessage = (event) => {
                    // Display the terminal output from the Colab VM
                    outputElement.innerHTML += event.data;
                    outputElement.scrollTop = outputElement.scrollHeight;
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'Connection Closed. Restart Ngrok in Colab.');
                    appendOutput("\nConnection to the remote terminal was lost.", false);
                };

                ws.onerror = (error) => {
                    updateStatus('disconnected', 'Connection Error. Check URL and Colab runtime.');
                    appendOutput(`WebSocket Error: Could not connect to ${url}`, false);
                    console.error("WebSocket Error:", error);
                };
            } catch (error) {
                updateStatus('disconnected', 'Invalid URL Format');
                appendOutput(`Invalid URL provided: ${url}`, false);
            }
        }

        // Event listener for the input field (on Enter key)
        inputElement.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !inputElement.disabled && ws && ws.readyState === WebSocket.OPEN) {
                event.preventDefault();
                const commandLine = inputElement.value.trim();
                inputElement.value = '';
                
                // 1. Display the command locally (user feedback)
                appendOutput(commandLine, true);

                // 2. Send the command + newline to the WebSocket server
                ws.send(commandLine + '\n');
            }
        });

        // Event listener for the connect button
        connectButton.addEventListener('click', handleConnect);
        
    </script>
</body>
</html>
